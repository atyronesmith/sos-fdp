kind: MachineConfig
apiVersion: machineconfiguration.openshift.io/v1
metadata:
  name: 99-vfio-noiommu
  labels:
    machineconfiguration.openshift.io/role: worker
spec:
  osImageURL: ''
  config:
    ignition:
      version: 2.2.0
    storage:
      files:
      - filesystem: root
        path: "/etc/modprobe.d/vfio-noiommu.conf"
        contents:
          source: data:text/plain;charset=utf-8;base64,b3B0aW9ucyB2ZmlvIGVuYWJsZV91bnNhZmVfbm9pb21tdV9tb2RlPTEK
          verification: {}
        mode: 0644
      - filesystem: root
        path: "/usr/local/bin/driverctl"
        contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCmNvbmZkaXI9L2V0Yy9kcml2ZXJjdGwuZApidXM9JHtTVUJTWVNURU06LXBjaX0KcHJvYmU9MQpzYXZlPTEKZGVidWc9MAoKZGVjbGFyZSAtQSBkZXZjbGFzc2VzCmRldmNsYXNzZXM9KFsiYWxsIl09IiIKICAgICAgICAgICAgWyJzdG9yYWdlIl09IjAxIgogICAgICAgICAgICBbIm5ldHdvcmsiXT0iMDIiCiAgICAgICAgICAgIFsiZGlzcGxheSJdPSIwMyIKICAgICAgICAgICAgWyJtdWx0aW1lZGlhIl09IjA0IgogICAgICAgICAgICBbIm1lbW9yeSJdPSIwNSIKICAgICAgICAgICAgWyJicmlkZ2UiXT0iMDYiCiAgICAgICAgICAgIFsiY29tbXVuaWNhdGlvbiJdPSIwNyIKICAgICAgICAgICAgWyJzeXN0ZW0iXT0iMDgiCiAgICAgICAgICAgIFsiaW5wdXQiXT0iMDkiCiAgICAgICAgICAgIFsiZG9ja2luZyJdPSIwYSIKICAgICAgICAgICAgWyJwcm9jZXNzb3IiXT0iMGIiCiAgICAgICAgICAgIFsic2VyaWFsIl09IjBjIgopCgpmdW5jdGlvbiBsb2coKQp7CiAgICBlY2hvICJkcml2ZXJjdGw6ICQqIiA+JjIKfQoKZnVuY3Rpb24gZGVidWcoKQp7CiAgICBbICIkZGVidWciIC1uZSAwIF0gJiYgbG9nICIkQCIKfQoKZnVuY3Rpb24gZXJyb3IoKQp7CiAgICBsb2cgIiRAIgogICAgZXhpdCAxCn0KCmZ1bmN0aW9uIHVzYWdlKCkKewogICAgZWNobyAiVXNhZ2U6IGRyaXZlcmN0bCBbT1BUSU9OUy4uLl0ge0NPTU1BTkR9Li4uIgogICAgZWNobwogICAgZWNobyAiSW5zcGVjdCBvciBjb250cm9sIGRlZmF1bHQgZGV2aWNlIGRyaXZlciBiaW5kaW5ncy4iCiAgICBlY2hvCiAgICBlY2hvICJTdXBwb3J0ZWQgY29tbWFuZHM6IgogICAgZWNobyAiICBzZXQtb3ZlcnJpZGUgPGRldmljZT4gPGRyaXZlcj4gICAgTWFrZSA8ZHJpdmVyPiB0aGUgZGVmYXVsdCBkcml2ZXIiCiAgICBlY2hvICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgPGRldmljZT4iCiAgICBlY2hvICIgIHVuc2V0LW92ZXJyaWRlIDxkZXZpY2U+ICAgICAgICAgICBSZW1vdmUgYW55IG92ZXJyaWRlIGZvciA8ZGV2aWNlPiIKICAgIGVjaG8gIiAgbG9hZC1vdmVycmlkZSA8ZGV2aWNlPiAgICAgICAgICAgIExvYWQgYW4gb3ZlcnJpZGUgcHJldmlvdXNseSBzcGVjaWZpZWQiCiAgICBlY2hvICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgPGRldmljZT4iCiAgICBlY2hvICIgIGxpc3QtZGV2aWNlcyAgICAgICAgICAgICAgICAgICAgICBMaXN0IGFsbCBvdmVycmlkYWJsZSBkZXZpY2VzIgogICAgZWNobyAiICBsaXN0LW92ZXJyaWRlcyAgICAgICAgICAgICAgICAgICAgTGlzdCBhbGwgY3VycmVudGx5IHNwZWNpZmllZCBvdmVycmlkZXMiCiAgICBlY2hvCiAgICBlY2hvICJTdXBwb3J0ZWQgb3B0aW9uczoiCiAgICBlY2hvICIgLWggLS1oZWxwICAgICAgICAgICAgIFNob3cgdGhpcyBoZWxwIgogICAgZWNobyAiIC12IC0tdmVyYm9zZSAtLWRlYnVnICBTaG93IHZlcmJvc2UgZGVidWcgaW5mb3JtYXRpb24iCiAgICBlY2hvICIgLWIgLS1idXMgPGJ1cz4gICAgICAgIFdvcmsgb24gYnVzIDxidXM+IChkZWZhdWx0IHBjaSkiCiAgICBlY2hvICIgICAgLS1ub3Byb2JlICAgICAgICAgIERvIG5vdCByZXByb2JlIHdoZW4gc2V0dGluZywgdW5zZXR0aW5nLCBvciIKICAgIGVjaG8gIiAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZyBhbiBvdmVycmlkZSIKICAgIGVjaG8gIiAgICAtLW5vc2F2ZSAgICAgICAgICAgRG8gbm90IHNhdmUgY2hhbmdlcyB3aGVuIHNldHRpbmcgb3IgdW5zZXR0aW5nIgogICAgZWNobyAiICAgICAgICAgICAgICAgICAgICAgICBhbiBvdmVycmlkZSIKICAgIGVjaG8gIiIKfQoKZnVuY3Rpb24gdW5iaW5kKCkKewogICAgaWYgWyAtTCAiJHN5c3BhdGgvZHJpdmVyIiBdOyB0aGVuCiAgICAgICAgZGVidWcgInVuYmluZGluZyBwcmV2aW91cyBkcml2ZXIgJChiYXNlbmFtZSAiJChyZWFkbGluayAiJHN5c3BhdGgvZHJpdmVyIikiKSIKICAgICAgICBpZiAhIGVjaG8gIiRkZXYiID4gIiRzeXNwYXRoL2RyaXZlci91bmJpbmQiOyB0aGVuCiAgICAgICAgICAgIGVycm9yICJ1bmJpbmRpbmcgJGRldiBmYWlsZWQiCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBkZWJ1ZyAiZGV2aWNlICRkZXYgbm90IGJvdW5kIiAKICAgIGZpCn0KCmZ1bmN0aW9uIHByb2JlX2RyaXZlcigpCnsKICAgIGRlYnVnICJyZXByb2JpbmcgZHJpdmVyIGZvciAkZGV2IgogICAgZWNobyAiJGRldiIgPiAiL3N5cy9idXMvJGJ1cy9kcml2ZXJzX3Byb2JlIgp9CgpmdW5jdGlvbiBzYXZlX292ZXJyaWRlKCkKewogICAgZGVidWcgInNhdmluZyBkcml2ZXIgb3ZlcnJpZGUgZm9yICRkZXYiCiAgICBpZiBbIC1uICIkZHJ2IiBdOyB0aGVuCglbIC1kICIkY29uZmRpciIgXSB8fCBta2RpciAtcCAiJGNvbmZkaXIiCiAgICAgICAgZWNobyAiJGRydiIgPiAiJGNvbmZkaXIvJHNkZGV2IgogICAgZWxzZQogICAgICAgIHJtIC1mICIkY29uZmRpci8kc2RkZXYiCiAgICBmaQp9CgpmdW5jdGlvbiBsaXN0X2RldmljZXMoKQp7CiAgICBkZXZpY2VzPSgpCiAgICBmb3IgZCBpbiAiL3N5cy9idXMvJGJ1cy9kZXZpY2VzIi8qOyBkbwogICAgICAgIGlmIFsgLWYgIiRkL2RyaXZlcl9vdmVycmlkZSIgXTsgdGhlbgogICAgICAgICAgICBvdmVycmlkZT0iJCg8ICIkZC9kcml2ZXJfb3ZlcnJpZGUiKSIKICAgICAgICAgICAgaWYgWyAiJDEiIC1lcSAxIF0gJiYgWyAiJG92ZXJyaWRlIiA9PSAiKG51bGwpIiBdOyB0aGVuCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBmaQogICAgICAgICAgCiAgICAgICAgICAgIGxpbmU9IiQoYmFzZW5hbWUgIiRkIikiCiAgICAgICAgICAgIGRldmljZXMrPSgiJGxpbmUiKQoKICAgICAgICAgICAgaWYgWyAtbiAiJDIiIF07IHRoZW4KICAgICAgICAgICAgICAgIGNsYXNzPSIkKDwgIiRkL2NsYXNzIikiCiAgICAgICAgICAgICAgICBbICIkMiIgPT0gIiR7Y2xhc3M6MjoyfSIgXSB8fCBjb250aW51ZQogICAgICAgICAgICBmaQogICAgICAgICAgICBpZiBbIC1MICIkZC9kcml2ZXIiIF07IHRoZW4KICAgICAgICAgICAgICAgIGxpbmUrPSIgJChiYXNlbmFtZSAiJChyZWFkbGluayAiJGQvZHJpdmVyIikiKSIKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgbGluZSs9IiAobm9uZSkiCiAgICAgICAgICAgIGZpCiAgICAgICAgICAgIGlmIFsgIiQxIiAtbmUgMSBdICYmIFsgIiRvdmVycmlkZSIgIT0gIihudWxsKSIgXTsgdGhlbgogICAgICAgICAgICAgICAgbGluZSs9IiBbKl0iCiAgICAgICAgICAgIGZpCgogICAgICAgICAgICBpZiBbICRkZWJ1ZyAtbmUgMCBdOyB0aGVuCiAgICAgICAgICAgICAgICBsaW5lKz0iICgkKHVkZXZhZG0gaW5mbyAtcSBwcm9wZXJ0eSAiJGQiIHwgZ3JlcCBJRF9NT0RFTF9GUk9NX0RBVEFCQVNFIHwgY3V0IC1kPSAtZjIpKSIKICAgICAgICAgICAgZmkKICAgICAgICAgICAgZWNobyAiJGxpbmUiCiAgICAgICAgZmkKICAgIGRvbmUKICAgIGlmIFsgJHsjZGV2aWNlc1tAXX0gLWVxIDAgXTsgdGhlbgogICAgICAgIGVycm9yICJObyBvdmVycmlkYWJsZSBkZXZpY2VzIGZvdW5kLiBLZXJuZWwgdG9vIG9sZD8iCiAgICBmaQp9CgpmdW5jdGlvbiBzZXRfb3ZlcnJpZGUoKQp7CiAgICBpZiBbICEgLWYgIiRzeXNwYXRoL2RyaXZlcl9vdmVycmlkZSIgXTsgdGhlbgogICAgICAgIGVycm9yICJkZXZpY2UgZG9lcyBub3Qgc3VwcG9ydCBkcml2ZXIgb3ZlcnJpZGU6ICRkZXYiCiAgICBmaQogICAgaWYgWyAtbiAiJGRydiIgXSAmJiBbICIkZHJ2IiAhPSAibm9uZSIgXTsgdGhlbgogICAgICAgIGRlYnVnICJzZXR0aW5nIGRyaXZlciBvdmVycmlkZSBmb3IgJGRldjogJGRydiIKICAgICAgICBpZiBbICEgLWQgIi9zeXMvbW9kdWxlLyRkcnYiIF07IHRoZW4KICAgICAgICAgICAgZGVidWcgImxvYWRpbmcgZHJpdmVyICRkcnYiCiAgICAgICAgICAgIC9zYmluL21vZHByb2JlIC1xICIkZHJ2IiB8fCBlcnJvciAibm8gc3VjaCBtb2R1bGU6ICRkcnYiCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBkZWJ1ZyAidW5zZXR0aW5nIGRyaXZlciBvdmVycmlkZSBmb3IgJGRldiIKICAgIGZpCiAgICB1bmJpbmQKICAgIGVjaG8gIiRkcnYiID4gIiRzeXNwYXRoL2RyaXZlcl9vdmVycmlkZSIKCiAgICBpZiBbICIkZHJ2IiAhPSAibm9uZSIgXSAmJiBbICRwcm9iZSAtbmUgMCBdOyB0aGVuIAogICAgICAgIHByb2JlX2RyaXZlcgogICAgICAgIGlmIFsgISAtTCAiJHN5c3BhdGgvZHJpdmVyIiBdOyB0aGVuCiAgICAgICAgICAgIGVycm9yICJmYWlsZWQgdG8gYmluZCBkZXZpY2UgJGRldiB0byBkcml2ZXIgJGRydiIKICAgICAgICBmaQogICAgZmkKfQoKd2hpbGUgKCgkIyA+IDApKTsgZG8KICAgIGNhc2UgJHsxfSBpbgogICAgLS1ub3Byb2JlKQogICAgICAgIHByb2JlPTAKICAgICAgICA7OwogICAgLS1ub3NhdmUpCiAgICAgICAgc2F2ZT0wCiAgICAgICAgOzsKICAgIC0tZGVidWd8LS12ZXJib3NlfC12KQogICAgICAgIGRlYnVnPTEKICAgICAgICA7OwogICAgLWJ8LS1idXMpCiAgICAgICAgYnVzPSR7Mn0KICAgICAgICBzaGlmdAogICAgICAgIDs7CiAgICAtaHwtLWhlbHB8LSopCiAgICAgICAgdXNhZ2UKICAgICAgICBleGl0IDAKICAgICAgICA7OwogICAgc2V0LW92ZXJyaWRlKQogICAgICAgIGlmIFsgJCMgLW5lIDMgXTsgdGhlbgogICAgICAgICAgICB1c2FnZQogICAgICAgICAgICBleGl0IDEKICAgICAgICBmaQoKICAgICAgICBjbWQ9JDEKICAgICAgICBkZXY9JDIKICAgICAgICBkcnY9JDMKICAgICAgICBicmVhawogICAgICAgIDs7CiAgICBsb2FkLW92ZXJyaWRlfHVuc2V0LW92ZXJyaWRlKQogICAgICAgIGlmIFsgJCMgLW5lIDIgXTsgdGhlbgogICAgICAgICAgIHVzYWdlCiAgICAgICAgICAgZXhpdCAxCiAgICAgICAgZmkKCiAgICAgICAgY21kPSQxCiAgICAgICAgZGV2PSQyCiAgICAgICAgYnJlYWsKICAgICAgICA7OwogICAgbGlzdC1kZXZpY2VzfGxpc3Qtb3ZlcnJpZGVzKQogICAgICAgIGlmIFsgJCMgLWd0IDIgXTsgdGhlbgogICAgICAgICAgICB1c2FnZQogICAgICAgICAgICBleGl0IDEKICAgICAgICBmaQoKICAgICAgICBpZiBbIC1uICIkMiIgXSAmJiBbICEgIiR7ZGV2Y2xhc3Nlc1skMl0rX30iIF07IHRoZW4KICAgICAgICAgICAgZXJyb3IgImRldmljZSB0eXBlIG11c3QgYmUgb25lIG9mOiAkeyFkZXZjbGFzc2VzWypdfSIKICAgICAgICBmaQogICAgICAgIGNtZD0kMQogICAgICAgIGRldnR5cGU9IiR7ZGV2Y2xhc3Nlc1skezI6LWFsbH1dfSIKICAgICAgICBicmVhawogICAgICAgIDs7CiAgICAqKQogICAgICAgIHVzYWdlCiAgICAgICAgZXhpdCAxCiAgICAgICAgOzsKICAgIGVzYWMKICAgIHNoaWZ0CmRvbmUKCmlmIFsgLXogIiRjbWQiIF07IHRoZW4KICAgIHVzYWdlCiAgICBleGl0IDEKZmkKCmlmIFsgLW4gIiRkZXYiIF07IHRoZW4KICAgICAgICBjYXNlICR7ZGV2fSBpbgogICAgICAgICovKikKICAgICAgICAgICAgYnVzPSR7ZGV2JSUvKn0KICAgICAgICAgICAgZGV2PSR7ZGV2IyovfQogICAgICAgICAgICA7OwogICAgICAgIGVzYWMKICAgICAgICBpZiBbIC1uICIke0RFVlBBVEg6LX0iIF07IHRoZW4KICAgICAgICAgICAgZGV2cGF0aD0iJERFVlBBVEgiCiAgICAgICAgZWxzZQogICAgICAgICAgICBkZXZsaW5rPSIvc3lzL2J1cy8kYnVzL2RldmljZXMvJGRldiIKICAgICAgICAgICAgWyAtTCAiJGRldmxpbmsiIF0gfHwgZXJyb3IgIm5vIHN1Y2ggZGV2aWNlOiAkZGV2IgogICAgICAgICAgICBkZXZwYXRoPSQocmVhbHBhdGggIiRkZXZsaW5rIiB8IGN1dCAtYzUtKQogICAgICAgIGZpCiAgICAgICAgc3lzcGF0aD0iL3N5cy8kZGV2cGF0aCIKICAgICAgICBzZGRldj0iJGJ1cy0kZGV2IgpmaQoKY2FzZSAke2NtZH0gaW4KICAgIGxvYWQtb3ZlcnJpZGUpCiAgICAgICAgaWYgWyAtcyAiJGNvbmZkaXIvJHNkZGV2IiBdOyB0aGVuCiAgICAgICAgICAgIGRydj0kKDwgIiRjb25mZGlyLyRzZGRldiIpCgkgICAgc2V0X292ZXJyaWRlICIkZGV2IiAiJGRydiIKICAgICAgICBlbHNlCiAgICAgICAgICAgIGV4aXQgMQogICAgICAgIGZpCiAgICAgICAgOzsKICAgIGxpc3QtZGV2aWNlcykKICAgICAgICBsaXN0X2RldmljZXMgMCAiJGRldnR5cGUiCiAgICAgICAgOzsKICAgIGxpc3Qtb3ZlcnJpZGVzKQogICAgICAgIGxpc3RfZGV2aWNlcyAxICIkZGV2dHlwZSIKICAgICAgICA7OwogICAgc2V0LW92ZXJyaWRlKQogICAgICAgIHNldF9vdmVycmlkZSAiJGRldiIgIiRkcnYiCiAgICAgICAgaWYgWyAkc2F2ZSAtbmUgMCBdOyB0aGVuCiAgICAgICAgICAgc2F2ZV9vdmVycmlkZQogICAgICAgIGZpCgogICAgICAgIDs7ICAgICAgIAogICAgdW5zZXQtb3ZlcnJpZGUpCiAgICAgICAgc2V0X292ZXJyaWRlICIkZGV2IiAiIgogICAgICAgIGlmIFsgJHNhdmUgLW5lIDAgXTsgdGhlbgogICAgICAgICAgIHNhdmVfb3ZlcnJpZGUKICAgICAgICBmaQogICAgICAgIDs7CmVzYWMK
          verification: {}
        mode: 0755
    # systemd:
    #   units:
    #     - contents: |
    #         [Unit]
    #         Requires=systemd-udevd.target
    #         After=systemd-udevd.target
    #         Before=NetworkManager.service
    #         [Service]
    #         Type=oneshot
    #         ExecStart=/usr/local/bin/driverctl set-override 0000:00:06.0 vfio-pci
    #         [Install]
    #         WantedBy=multi-user.target
    #       name: one-shot-vfs-bind.service
    #       enabled: true